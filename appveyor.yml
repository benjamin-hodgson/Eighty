image: Visual Studio 2017
configuration: Release

environment:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

nuget:
  project_feed: true
  disable_publish_on_pr: true

install:
  - ps: |
      $lastTag = git describe --abbrev=0
      Update-AppveyorBuild -Version "$lastTag-$env:APPVEYOR_BUILD_NUMBER"
  - cmd: msbuild Eighty.sln /t:restore /p:Configuration=%CONFIGURATION% /v:Minimal
  - cmd: cinst docfx

build:
  project: Eighty.sln
  verbosity: minimal

after_build:
  - cmd: docfx Eighty.Docs/docfx.json

after_test:
  - cmd: dotnet run --configuration %CONFIGURATION% --project Eighty.Bench\Eighty.Bench.csproj
  - cmd: msbuild Eighty.sln /t:pack /p:Configuration=%CONFIGURATION% /p:IncludeSymbols=true /p:PackageOutputPath=..\nupkgs /v:Minimal

artifacts:
  - type: NuGetPackage
    path: nupkgs/*.nupkg
  - path: BenchmarkDotNet.Artifacts
  - path: Eighty.Docs/_site

deploy:
  provider: NuGet
  skip_symbols: false
  api_key:
    secure: lB7Y+xQbPUQVGKuRLirkOR/bODAnTpJM3m+myEsp7Ed0FTxk35L2g2hR+F4mLNdz
  on:
    appveyor_repo_tag: true